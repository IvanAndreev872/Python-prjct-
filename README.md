# Python-prjct
[Бот](https://t.me/beauty_essential_bot)
[Презентация](https://docs.google.com/presentation/d/1_PMkhJ-0-AxlrcBI3oy_hpLXp10rgIzDrl1lILCVcyQ/edit?usp=sharing) c видео работы бота и тестов.

По вопросам писать  [@kokosov_kokosov](https://t.me/kokosov_kokosov)

### Функционал бота:
 1. Запись к определенному мастеру (требуется подгружать график работы)
 2. Уведомления о предстощем мероприятии
 3. Запрос о подтверждении записи
 4. Предложить подгрузить запись в гугл/эпл календарь
 5. Добавить функционал для мастера (отправлять информацию о записях)
 6. Собирать и визуализировать статистику для салона  (excel/csv)"

## UI бота:

### Главный экран:
**Кнопки:**
1. **Записаться на процедуру**  
2. **Мои записи**
3. **Для мастеров** (доступ только для мастеров, скрыто для обычных пользователей)
4. **Для админов** 
 
---
 
### 1. Экран записи на процедуру
После нажатия на "Записаться на процедуру":
- **Выберите мастера**: выводится список доступных мастеров с кнопками.
 
  **После выбора мастера:**
  - **Выберите дату**: бот подгружает доступные даты из графика работы мастера.
 
  - **Выберите время**: на основе выбранной даты бот покажет доступные временные слоты.
 
  - **Выберите процедуру** (если в салоне разные услуги). Список процедур мастера с описанием и ценой.
 
- **Кнопка Подтвердить** – после выбора всех данных.
 
  После нажатия на кнопку подтверждения:
  - Бот уточняет: *"Подтвердить запись на [дата, время, мастер, услуга]?"*
  - **Да** / **Нет**
 
  При подтверждении записи:
  - Запись подтверждена и отображается уведомление: *"Вы записаны на [дата, время] к [имя мастера] на [услуга]."*
 
  **После подтверждения записи:**
  - Уведомление: *"Желаете добавить запись в календарь?"* с кнопками:
    - **Добавить в Google Calendar**
    - **Добавить в Apple Calendar**
 
  Если пользователь выбирает один из вариантов, бот отправляет соответствующий файл/ссылку для добавления в календарь.
 
---
 
### 2. Уведомления о предстоящем мероприятии
Перед процедурой (например, за день и за час) бот автоматически отправляет уведомления:
- *"Напоминаем, что у вас завтра запись на [время] к [имя мастера]. Подтверждаете?"*
 
  **Кнопки:**
  - **Подтвердить**
  - **Отменить**
 
  При нажатии на "Отменить" запись удаляется, мастер получает уведомление о снятии записи.
 
---
 
### 3. Мои записи
Пользователь может посмотреть свои записи:
- Список предстоящих записей с информацией (дата, время, мастер, услуга).
 
  **Кнопки на каждую запись:**
  - **Подтвердить**
  - **Отменить запись**
 
---
 
### 4. Экран для мастеров (закрытая секция)
Мастера могут отправлять записи и график работы.
 
**Кнопки для мастера:**
1. **Отправить график работы**
   - Мастер указывает дни и часы работы. Можно загрузить заранее подготовленный файл с графиком.
 
2. **Мои записи**  
   - Мастер видит список предстоящих записей и может свзаться с записанными клиентами. 
 
   **Для каждой записи:**
   - **Уведомить клиента** (может быть полезно для уведомлений об изменениях, можно использовать для связи с клиентом).
   - **Изменить запись** (изменение даты/времени по договоренности с клиентом).
 
3. **Отправить статистику салону**
   - Автоматически генерировать отчёт с выбором формата **Excel** или **CSV**, который отправляется администратору салона.
 
---

### 5. Экран для администраторов (закрытая секция)

**Кнопки для админа:**
1. **Добавить нового мастера**
    - Ввожится имя, telegram id и в последующих сообщениях перечисляются услуги.
      
2. **Добавить новую услугу**
    - Вводится название, затем цена и продолжительность
      
3. **Запросить статистику**
   - Можно выбрать период (кол-во суток или весь период)
     
4. **Задать частоту отчетности**
   - Вводится кол-во суток - период, с которым статистика присылается всем админам.
 
### 6. Статистика для салона
Бот может отправлять отчёт в указанный день или по запросу (например, раз в месяц). В статистике:
- Общее количество записей по каждому мастеру.
- Процент отменённых записей.
- Выручка по мастерам и услугам.
- Пиковые часы и дни.
 
Отчёт в формате **Excel** или **CSV** с таблицами и графиками, если нужно

---

## Структура проекта

### 1. Общая структура директорий
 
```
project/
│
├── bot/                    # Основной код бота
│   ├── handlers/           # Обработчики команд и сообщений
│   │   ├── user_handlers.py        # Команды для клиентов
│   │   ├── master_handlers.py      # Команды для мастеров
│   │   └── admin_handlers.py       # Команды для администраторов
│   │
│   ├── keyboards/          # Клавиатуры и кнопки
│   │   ├── inline_keyboards.py     # Инлайн-кнопки
│   │   └── reply_keyboards.py      # Обычные кнопки
│   │
│   ├── middlewares/        # Миддлвары для промежуточной обработки данных
│   │   └── authorization.py        # Проверка ролей пользователей
│   │
│   ├── utils/              # Вспомогательные функции
│   │   ├── calendar_utils.py       # Интеграция с календарём
│   │   └── notification_scheduler.py  # Запуск и управление уведомлениями
│   │
│   ├── database/           # Работа с БД
│   │   ├── models.py              # Модели базы данных (ORM-схемы)
│   │   ├── db_utils.py            # Общие функции работы с БД
│   │   └── migrations/            # Миграции базы данных
│   │
│   ├── notifications/      # Логика уведомлений
│   │   └── reminders.py           # Планировщик для отправки уведомлений
│   │
│   └── main.py             # Основной файл запуска бота
│
├── config/                 # Конфигурация проекта
│   ├── settings.py         # Настройки проекта (токены, параметры БД)
│   └── logging_config.py   # Конфигурация логирования
│
├── requirements.txt        # Зависимости Python
├── README.md               # Документация проекта
└── Dockerfile              # Docker-образ для контейнеризации приложения
```
 
---
 
### 2. База данных
 
Реляционная база данных, например, **SQLite**. 
 
#### Основные таблицы:
 
- **users** — данные о пользователях, включая клиентов и мастеров.
- **masters** — данные о мастерах.
- **services** — данные о доступных услугах.
- **schedules** — расписание работы мастеров.
- **appointments** — записи на процедуры.
- **notifications** — напоминания и подтверждения для пользователей.
- **statistics** — информация для отчётов по салону.
 
---
 
### 3. Архитектура бота и слои приложения
 
#### Бот (Telegram Bot API)
 
- **Запуск бота** — файл `main.py`, который инициализирует бота, настраивает обработчики и подключает базы данных.
- **Обработчики команд**:
  - `user_handlers.py`: обработка команд пользователя (запись, подтверждение, отмена).
  - `master_handlers.py`: команды мастеров (управление расписанием, просмотр записей).
  - `admin_handlers.py`: команды администратора (управление статистикой, рассылка).
- **Клавиатуры и кнопки** — используются для удобной навигации в Telegram (инлайн и reply-кнопки).
 
#### Middlewares (middlewares/)
 
- **Авторизация** — проверяет роли пользователей и открывает доступ к нужным функциям.
- **Журналирование** — логирует действия пользователей для аналитики.
 
#### Scheduler (notifications/)
 
- Модуль `reminders.py` для управления уведомлениями:
  - `reminder_24h` и `reminder_1h` напоминания с помощью планировщика.
  - **APScheduler** или `celery` для периодических задач по отправке уведомлений и генерации отчётов.
- Уведомления также отправляются пользователям для подтверждения записи.
 
#### Вспомогательные модули (utils/)
 
- **calendar_utils.py** — функции для создания `.ics` файлов и добавления событий в календарь.
- **notification_scheduler.py** — отправка сообщений по расписанию с использованием асинхронного планировщика.
 
#### Конфигурация (config/)
 
- **settings.py** — конфигурации приложения (токены, параметры БД, время уведомлений и т.д.).
- **logging_config.py** — настройки для ведения журнала событий.
 
#### Статистика и отчёты (database/)
 
- **statistics.py** — создание отчётов по данным из базы (сохраняются в `.xlsx` или `.csv`).
- **Автоматическая генерация статистики** с помощью планировщика по расписанию (например, раз в неделю или месяц).
 
---
 
### 4. Основные алгоритмы и внутренние функции
 
#### Обработка записи клиента
1. Получение доступных мастеров.
2. Получение расписания мастера и проверка доступности времени.
3. Запись на процедуру и добавление её в БД.
4. Отправка подтверждающего сообщения и возможности добавления в календарь.
 
#### Уведомления
1. Система планировщика, настроенная на отправку уведомлений за 24 часа и за 1 час до записи.
2. Функция отмены и подтверждения записи с изменением статуса в БД.
3. Логирование всех уведомлений (успешных и неуспешных) для анализа.
 
#### Сбор статистики
1. Запрос данных по количеству записей, отмен, выручке, активности мастеров.
2. Создание отчётов в формате `.xlsx` или `.csv` с помощью `pandas`.
3. Автоматическая отправка отчёта администраторам через Telegram.
 
---
 
### 5. Технические моменты
 
#### Безопасность
- **Защита данных** — шифрование паролей и ключей в конфигурациях.
- **Управление ролями и доступами** — использование миддлвара для проверки ролей пользователей (пользователь, мастер, администратор).
- **Логи и мониторинг** — отслеживание активности бота и логирование ошибок.

 ---

### Распределение задач среди команды:
1.1) Создать main, создать middleware, который проверят роль пользователя. Создать начальную клавиатуру. - Андреев Иван

1.2) Создать основные таблицы БД и все что входит в раздел database/ -- Рудаков Андрей

2) Реализовать запись на процедуру -- Иванов Артём и Андреев Иван

3) Добавление записи в календарь –- Мамадалиева Азиза

4) Реализация уведомлений -- Мурзина Екатерина

5) Реализация "мои записи" для клиента -- Рудаков Андрей

6) Экран для мастеров - Отправить график работы -- Андреев Иван

7) Экран для мастеров - Мои записи –- Иванов Артём

8) Создание статистики -- Мамадалиева Азиза

9) Раздел для админа -- Мурзина Екатерина
 
### Прогресс на КТ-2:

### Сделано:
1) Реализованны первые пункты проекта и смерджены в мэйн. Бот может записывать на процедуру и показывать список ваших записей, которые вам надо подтвердить.

2) Почти закончен раздел для мастеров, где они смогут ими становиться и присылать свое расписание и тд.

3) сделаны увеомления, статистика и прочее но пока все вмесете не собрано.

### Осталось сделать до экзамена:
1) Реализовать раздел для админа.

2) Закончить мелкие моменты и отдебажить имеющиеся.

3) Смерджить все в мэйн.

4) Написать тесты.

### Overall
До экзамена мы успеваем доделать то, что нам осталось, тк основная часть из того, что осталось - это тесты и раздел для админа.

### Ссылка на запись с работой нашего бота:
[Ссылка на Google Disk]{https://drive.google.com/file/d/1muD65dAtKLX_tYTcJ5TOIIC1kV23ABGK/view?usp=sharing}
